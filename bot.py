import logging
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import Message
from aiogram.enums import ParseMode
from config import AUTH_URL, PASSWORD, USERNAME, TG_TOKEN
from client_manager import ClientManager

client_manager = ClientManager(AUTH_URL, USERNAME, PASSWORD)
client_manager.authenticate()

API_TOKEN = TG_TOKEN

logging.basicConfig(level=logging.INFO)

bot = Bot(token=API_TOKEN)
dp = Dispatcher()


@dp.message(Command("start"))
async def cmd_start(message: Message):
    try:
        clients = client_manager.generate_clients(message.from_user.username)
        client_manager.add_clients(clients)
        key = client_manager.get_vless(message.from_user.username)
    except Exception as e:
        key = "ERROR"


    instructions = """
<b>üì≤ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é VPN –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤</b>
------------------------------
<b>‚ñ∂Ô∏è Android:</b>
1. –°–∫–∞—á–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ <a href="https://play.google.com/store/apps/details?id=app.hiddify.com">Hiddify-next (Google Play)</a> –∏–ª–∏ <a href="https://github.com/hiddify/hiddify-next/releases/download/v1.5.2/Hiddify-Android-universal.apk">APK-–≤–µ—Ä—Å–∏—é</a>
2. –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å —á–µ—Ä–µ–∑ ¬´–ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å ‚Üí –î–æ–±–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞¬ª
------------------------------
<b>‚ñ∂Ô∏è iOS:</b>
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ <a href="https://apps.apple.com/us/app/streisand/id6450534064">Streisend</a>
2. –î–ª—è –∏–º–ø–æ—Ä—Ç–∞ –ø—Ä–æ—Ñ–∏–ª—è –Ω–∞–∂–º–∏—Ç–µ + ‚Üí –î–æ–±–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞
------------------------------
<b>‚ñ∂Ô∏è macOS:</b>
üî∏ M1/M2: 
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º <a href="https://apps.apple.com/am/app/streisand/id6450534064">Streisand</a>
------------------------------
<b>‚ñ∂Ô∏è Windows:</b>
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ <a href="https://github.com/hiddify/hiddify-next/releases/download/v1.5.2/Hiddify-Windows-Setup-x64.exe">Hiddify-next</a>
2. –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
<i>–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: <a href="https://telegra.ph/Alternativnoe-prilozhenie-dlya-Windows--FlClash-10-09">FlClash</a></i>
------------------------------
<b>‚ñ∂Ô∏è Linux:</b>
1. –°–∫–∞—á–∞–π—Ç–µ <a href="https://github.com/hiddify/hiddify-next/releases/latest/download/Hiddify-Linux-x64.AppImage">Hiddify</a>
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å
"""
    await message.answer(text=instructions, parse_mode=ParseMode.HTML, disable_web_page_preview=True)
    await message.answer(text=f"<pre><code>{key}</code></pre>", parse_mode=ParseMode.HTML)


async def main():
    await dp.start_polling(bot)


if __name__ == "__main__":
    import asyncio
    asyncio.run(main())